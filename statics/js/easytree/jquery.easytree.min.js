'use strict';(function(g){g.fn.easytree=function(g){return new x(this,g)};var x=function(x,R){function S(a){var c=G(this);a=a.data;if(c=m(a,c))if(u(a),f.allowActivate&&(c.isActive=!0,g("#"+c.id).addClass("easytree-active"),f.stateChanged)){var b=H(a);f.stateChanged(a,b,c)}}function y(a){var c=G(this),b=a.data;(c=m(b,c))&&z(a,b,c)}function z(a,c,b){var e="";if(f.toggling&&(e=f.toggling(a,c,b),!1===e))return!1;if(b.isExpanded){if(f.closing&&(e=f.closing(a,c,b),!1===e))return!1}else if(f.opening&&(e=f.opening(a,c,b),!1===e))return!1;if(b.isLazy&&!b.isExpanded){var d=b.children&&0<b.children.length,e=!0;f.openLazyNode&&(e=f.openLazyNode(a,c,b,d));if(b.lazyUrl&&!1!==e)return I(b.lazyUrl,b.lazyUrlJson,function(e){e.d&&(e=e.d);e=p(e);g.isArray(e)?b.children=e:(b.children=[],b.children.push(e));q(c);J(a,c,b)}),!1}J(a,c,b)}function J(a,c,b){b.isExpanded?(r(c,b.id,"close"),v(b,"close"),f.closed&&f.closed(a,c,b)):(r(c,b.id,"open"),v(b,"open"),f.opened&&f.opened(a,c,b));f.toggled&&f.toggled(a,c,b)}function T(a){if(f.enableDnd){for(a=a.target;a&&!(-1<a.className.indexOf("easytree-draggable"));)a=a.parentElement;if(a)return K(h),u(h),g("#"+a.id).addClass("easytree-drag-source"),t(d),d.createClone=!(-1<a.className.indexOf("easytree-no-clone")),d.dragok=!0,d.sourceEl=a,d.sourceId=a.id,d.sourceNode=m(h,d.sourceId),!1}}function U(a){if(d.dragok&&f.enableDnd){d.createClone&&(d.clone||(d.clone=V(d.sourceEl),g(d.clone).appendTo("body")),d.clone.style.left=a.pageX+5+"px",d.clone.style.top=a.pageY+"px");var c=W(a.clientX,a.clientY);if(!c)w(),d.targetEl=null,d.targetId=null,d.targetNode=null,d.canDrop=!1;else if(c.id!=d.targetId)if(d.canDrop=!1,window.clearTimeout(d.openDelayTimeout),d.targetEl=c,d.targetId=c.id,d.targetNode=m(h,d.targetId),C("source:"+(d.sourceNode&&d.sourceNode.text?d.sourceNode.text:d.sourceId)),C("target:"+(d.targetNode&&d.targetNode.text?d.targetNode.text:d.targetId)),C("isAncester:"+D(d.sourceNode,d.targetId)),c=g("#"+d.targetId),D(d.sourceNode,d.targetId))E();else if(d.targetId==d.sourceId)w();else{if(f.canDrop){var b=null!=d.sourceNode,e=null!=d.targetNode;a=f.canDrop(a,h,b,b?d.sourceNode:d.sourceEl,e,e?d.targetNode:d.targetEl);if(!0===a){L();d.canDrop=!0;d.openDelayTimeout=window.setTimeout(function(){r(h,d.targetId,"open");v(d.targetNode,"open")},600);return}if(!1===a){E();return}}c.hasClass("easytree-reject")?E():c.hasClass("easytree-accept")?(L(),d.canDrop=!0,d.openDelayTimeout=window.setTimeout(function(){r(h,d.targetId,"open");v(d.targetNode,"open")},600)):w();return!1}}}function X(a){var c=null!=d.sourceNode,b=c?d.sourceNode:d.sourceEl,e=null!=d.targetNode,A=e?d.targetNode:d.targetEl,B=d.canDrop;w();g("#_st_clone_").remove();if(null===b||null===A)return t(d),!1;if(f.dropping&&!1===f.dropping(a,h,c,b,e,A,B))t(d);else return d.targetNode&&d.sourceNode&&B&&(d.targetNode.children||(d.targetNode.children=[]),F(h,d.sourceId),d.targetNode.children.push(d.sourceNode)),B&&(f.dropped&&f.dropped(a,h,c,b,e,A),q(h)),t(d),!1}function V(a){g(a).remove(".easytree-expander");a=g(a).clone().remove(".easytree-expander").removeClass("easytree-drag-source")[0];var c=a.children[0];c&&"easytree-expander"==c.className&&a.removeChild(c);a.style.display="block";a.style.position="absolute";a.style.opacity=.5;a.id="_st_clone_";a.style.zIndex=1E3;return a}function W(a,c){for(var b=document.elementFromPoint(a,c);b;){if(-1<b.className.indexOf("easytree-droppable"))return b;b=b.parentElement}return null}function t(a){a.canDrop=!1;a.createClone=!0;a.clone=null;a.dragok=!1;a.openDelayTimeout=null;a.targetEl=null;a.targetId=null;a.targetNode=null;a.sourceEl=null;a.sourceId=null;a.sourceNode=null}function G(a){for(;null!=a;){if(a.id)return a.id;a=a.parentElement}return null}function m(a,c){for(var b=0,b=0;b<a.length;b++){var e=a[b];if(e.id==c||e.children&&0<e.children.length&&(e=m(e.children,c)))return e}return null}function D(a,c){var b=0;if(!a||!a.children||0==a.children.length)return!1;for(b=0;b<a.children.length;b++){var e=a.children[b];if(e.id==c)return!0;if(e.children&&0<e.children.length&&(e=D(e,c)))return e}return!1}function F(a,c){for(var b=0,b=0;b<a.length;b++){var e=a[b];if(e.id==c){a.splice(b,1);break}e.children&&0<e.children.length&&F(e.children,c)}}function r(a,c,b){for(var e=0,e=0;e<a.length;e++){var d=a[e];if(d.id==c){d.isExpanded="open"==b;break}d.children&&0<d.children.length&&r(d.children,c,b)}}function u(a){for(var c=0,c=0;c<a.length;c++){var b=a[c];b.isActive=!1;g("#"+b.id).removeClass("easytree-active");b.children&&0<b.children.length&&u(b.children)}}function K(a){for(var c=0,c=0;c<a.length;c++){var b=a[c];g("#"+b.id).removeClass("easytree-drag-source");b.children&&0<b.children.length&&K(b.children)}}function M(a){var c=0;a=a.sort(function(a,b){var c=a.text.toLowerCase(),d=b.text.toLowerCase();c||(c="a");d||(d="a");-1<f.ordering.toLowerCase().indexOf("folder")&&a.isFolder&&(c="______"+c);-1<f.ordering.toLowerCase().indexOf("folder")&&b.isFolder&&(d="______"+d);var g=-1==f.ordering.indexOf(" DESC")?1:-1;return c<d?-1*g:c>d?1*g:0});for(c=0;c<a.length;c++){var b=a[c];b.children&&0<b.children.length&&M(b.children)}return a}function N(a,c,b){var e=0;c||(c=0,b="_st_node_"+b+"_");for(e=0;e<a.length;e++){var d=a[e];d.id||(d.id=b+e.toString());d.children&&0<d.children.length&&N(d.children,c+1,b+e+"_")}}function q(a){if(a){if(f.building&&!1===f.building(a))return!1;f.ordering&&(a=M(a));N(a,0,Math.floor(1E4*Math.random()));h=a;var c=O(a,0,!0);n[0].innerHTML=c;g(n.selector+" .easytree-node").on("click",a,S);g(n.selector+" .easytree-expander").on("click",a,y);g(n.selector+" .easytree-icon").on("click",a,y);g(n.selector+" .easytree-title").on("click",a,y);f.enableDnd&&(g(document).on("mousedown",T),g(document).on("mousemove",U),g(document).on("mouseup",X));f.built&&f.built(a);f.stateChanged&&(c=H(a),f.stateChanged(a,c))}}function O(a,c,b){var e,d=0,d="";0==c&&(d+="ui-easytree easytree-container easytree-focused");var g=c<f.minOpenLevels;e=""+('\x3cul tabindex\x3d"0" class\x3d"'+d+'" '+(0==c||b||g?"":" style\x3d'display:none' ")+'"\x3e');for(d=0;d<a.length;d++){b=a[d];!0===g&&(b.isExpanded=!0);var h=d==a.length-1,k;k=b;var l="easytree-node ";f.enableDnd&&(l+=" easytree-draggable ");k.liClass&&(l+=k.liClass);k.isFolder&&f.enableDnd?l+=" easytree-droppable easytree-accept ":f.enableDnd&&(l+=" easytree-droppable easytree-reject ");k.isActive&&f.allowActivate&&(l+=" easytree-active ");l+=P(k,h);h=k.isExpanded?"e":"c";k.isFolder&&(h+="f");k=l+=" easytree-ico-"+h;e+="\x3cli\x3e";e+='\x3cspan id\x3d"'+b.id+'" class\x3d"'+k+' "\x3e';e+=g?"":'\x3cspan class\x3d"easytree-expander"\x3e\x3c/span\x3e';e+=f.disableIcons?"":b.uiIcon?'\x3cspan class\x3d"easytree-custom-icon ui-icon '+b.uiIcon+'"\x3e\x3c/span\x3e':b.iconUrl?'\x3cspan\x3e\x3cimg src\x3d"'+b.iconUrl+'" /\x3e\x3c/span\x3e':'\x3cspan class\x3d"easytree-icon"\x3e\x3c/span\x3e';k="";l=b.tooltip?'title\x3d"'+b.tooltip+'"':"";h="easytree-title";b.textCss&&(h+=" "+b.textCss);k+="\x3cspan "+l+' class\x3d"'+h+'"\x3e';b.href&&(k+='\x3ca href\x3d"'+b.href+'" ',b.hrefTarget&&(k+=' target\x3d"'+b.hrefTarget+'" '),k+="\x3e");k+=b.text;b.href&&(k+="\x3c/a\x3e");k+="\x3c/span\x3e";e+=k;e+="\x3c/span\x3e";b.children&&0<b.children.length&&(e+=O(b.children,c+1,b.isExpanded));e+="\x3c/li\x3e"}return e+"\x3c/ul\x3e"}function P(a,c){var b=a.children&&0<a.children.length,d="",d=!b&&a.isLazy?"c":b?a.isExpanded?"e":"c":"n";c&&(d+="l");return" easytree-exp-"+d}function v(a,c){if(a){var b=g("#"+a.id).attr("class"),d=b.indexOf("easytree-exp-");if(-1<d){var h=b.indexOf(" ",d),b=-1<h?b.substring(d,h):b.substring(d);g("#"+a.id).removeClass(b);g("#"+a.id).addClass(P(a,!1))}b=g("#"+a.id).parents("li").first().children("ul").first();d=parseInt(f.slidingTime,10);"close"==c?b.slideUp(d):b.slideDown(d)}}function w(){g("#easytree-reject").hide();g("#easytree-accept").hide()}function L(){g("#easytree-accept").show();g("#easytree-reject").hide()}function E(){g("#easytree-reject").show();g("#easytree-accept").hide()}function H(a){for(a=JSON.stringify?JSON.stringify(a):"Please import json2.js";-1<a.indexOf(',"children":[]');)a=a.replace(',"children":[]',"");for(;-1<a.indexOf('"liClass":"",');)a=a.replace('"liClass":"",',"");for(;-1<a.indexOf('"textCss":"",');)a=a.replace('"textCss":"",',"");for(;-1<a.indexOf('"isExpanded":false,');)a=a.replace('"isExpanded":false,',"");for(;-1<a.indexOf('"isActive":false,');)a=a.replace('"isActive":false,',"");for(;-1<a.indexOf('"isFolder":false,');)a=a.replace('"isFolder":false,',"");for(;-1<a.indexOf('"isLazy":false,');)a=a.replace('"isLazy":false,',"");return a}function Y(){Z();t(d);g(document).on("mousemove",function(a){var c=a.pageY;a=a.pageX;document.getElementById("easytree-reject").style.top=c+10+"px";document.getElementById("easytree-reject").style.left=a+17+"px";document.getElementById("easytree-accept").style.top=c+10+"px";document.getElementById("easytree-accept").style.left=a+17+"px"})}function Z(){if(!g("#easytree-reject").length){var a;a='\x3cdiv id\x3d"easytree-reject" class\x3d"easytree-drag-helper easytree-drop-reject"\x3e\x3cspan class\x3d"easytree-drag-helper-img"\x3e\x3c/span\x3e\x3c/div\x3e';g("body").append(a)}g("#easytree-accept").length||(a='\x3cdiv id\x3d"easytree-accept" class\x3d"easytree-drag-helper easytree-drop-accept"\x3e\x3cspan class\x3d"easytree-drag-helper-img"\x3e\x3c/span\x3e\x3c/div\x3e',g("body").append(a))}function I(a,c,b){g.ajax({url:a,type:"POST",contentType:"application/json; charset\x3dutf-8",data:c,success:b,error:function(a,b,c){alert("Error: "+a.responseText)}})}function p(a){var c=null;"object"==typeof a?c=a:"string"==typeof a&&(a=g.trim(a),c=0==a.indexOf("[")||0==a.indexOf("{")?g.parseJSON(a):aa(a));return c}function aa(a){var c=[];g(a).children().each(function(a){c.push(Q(this))});return c}function Q(a){a=g(a);var c={},b=a.data();c.isActive=a.hasClass("isActive");a.removeClass("isActive");c.isFolder=a.hasClass("isFolder");a.removeClass("isFolder");c.isExpanded=a.hasClass("isExpanded");a.removeClass("isExpanded");c.isLazy=a.hasClass("isLazy");a.removeClass("isLazy");c.uiIcon=b.uiicon;c.liClass=a.attr("class");c.id=a.attr("id");if(b=a.children("a"))c.href=b.attr("href"),c.hrefTarget=b.attr("target");var d=a.children("img");d&&(c.iconUrl=d.attr("src"));c.textCss="";var f=a.children("span");f&&f.attr("class")&&(c.textCss+=f.attr("class")+" ");(f=b.children("span"))&&f.attr("class")&&(c.textCss+=f.attr("class")+" ");(f=d.children("span"))&&f.attr("class")&&(c.textCss+=f.attr("class")+" ");c.text=ba(a[0]);c.tooltip=a.attr("title");c.children=[];a.children("ul").children("li").each(function(a){c.children.push(Q(this))});return c}function ba(a){for(var c=0,c=0;c<a.childNodes.length;c++)for(var b=a.childNodes[c];b;){if(3==b.nodeType&&0<g.trim(b.nodeValue).length)return g.trim(b.nodeValue);b=b.firstChild}return""}function C(a){a||(a="null");console.log(a)}var f={allowActivate:!0,data:null,dataUrl:null,dataUrlJson:null,disableIcons:!1,enableDnd:!1,ordering:null,slidingTime:100,minOpenLevels:0,building:null,built:null,toggling:null,toggled:null,opening:null,opened:null,openLazyNode:null,closing:null,closed:null,canDrop:null,dropping:null,dropped:null,stateChanged:null},n,h=null,d={};this.init=function(a,c){f=g.extend(f,c);Y();n=a;var b="";if(f.dataUrl)I(f.dataUrl,f.dataUrlJson,function(a){b=p(a);if(!b)return alert("EasyTree: Invalid data!"),this;q(b);return this});else{b=f.data?p(f.data):p(n.text());if(!b)return alert("EasyTree: Invalid data!"),this;q(b)}return this};this.options=f;this.rebuildTree=function(a){(a=a?p(a):h)||alert("EasyTree: Invalid data!");q(a)};this.getAllNodes=function(){return h};this.getNode=function(a){return m(h,a)};this.addNode=function(a,c){if(c){var b=m(h,c);a&&(b.children||(b.children=[]),b.children.push(a))}else h.push(a)};this.removeNode=function(a){F(h,a)};this.activateNode=function(a){u(h);f.allowActivate&&(a=m(h,a))&&(a.isActive=!0,g("#"+a.id).addClass("easytree-active"))};this.toggleNode=function(a){(a=m(h,a))&&z(null,h,a)};this.toggleNodes=function(a){a&&z(null,h,a)};this.init(x,R)}})(jQuery);